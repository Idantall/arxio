# תיקון בעיות אימות וסריקות במערכת

## רקע

המערכת נתקלה במספר שגיאות בתהליך האימות ויצירת סריקות חדשות. הבעיות העיקריות היו:

1. בעיות בחיבור בין משתמשי NextAuth למשתמשי Supabase
2. מחסור בהרשאות מתאימות לגישה לטבלאות
3. שגיאות בגישה ישירה מצד הלקוח לטבלאות (400/406)
4. שגיאת `AuthSessionMissingError` בצד הלקוח
5. שגיאת `Multiple GoTrueClient instances` בשל ריבוי התחברויות לסופאבייס
6. ייבוא בעייתי ל-`isValidUUID` מספריה לא קיימת

## פתרון

התיקונים כללו:

### 1. יצירת API ייעודיים בצד השרת במקום גישה ישירה מצד הלקוח

- נקודת קצה `/api/users/me` - מחזירה פרטי משתמש מחובר דרך שרת עם Service Role
- תיקון נקודת קצה `/api/fix-auth` - שימוש בחיבור ישיר לסופאבייס במקום ספריה חיצונית
- פישוט נקודת קצה `/api/scans` - מבנה נתונים פשוט יותר שפחות חשוף לשגיאות

### 2. שימוש במפתח Service Role בצד השרת

הגישה לסופאבייס בצד השרת משתמשת במפתח Service Role במקום מפתח אנונימי, המאפשר:

- גישה ישירה לתוכן הטבלאות ללא צורך בהרשאות RLS
- יכולת לחפש ולנהל משתמשים בטבלת Auth
- יכולת לתקן ולסנכרן משתמשים בין NextAuth לסופאבייס

### 3. אסטרטגיות לטיפול בשגיאות

- חיפוש משתמש תמיד מנסה קודם לפי מזהה, אח"כ לפי אימייל, ואם לא מוצא - יוצר משתמש חדש
- שמירת מזהה המשתמש בסשן במקום להסתמך על חיבור Supabase בצד הלקוח
- טיפול שקוף בשגיאות עם מנגנוני התאוששות אוטומטיים (למשל יצירת משתמשים חסרים)

### 4. מניעת ריבוי מופעי Supabase Client

- יצירת פונקציית `getSupabaseClient()` שמחזירה תמיד את אותו מופע בצד הלקוח
- החלפת קריאות ישירות ל-`createClient` בקריאות לפונקציה המקומית
- הוספת `credentials: 'include'` לקריאות fetch כדי לוודא שליחת עוגיות אימות

### 5. תיקון הפונקציונליות של `fix-auth`

- שימוש בפונקציה מקומית לבדיקת UUID תקין במקום ייבוא מספריה לא קיימת
- פישוט התהליך וכתיבת גרסה יעילה יותר ללא תלויות חיצוניות
- מתן תשובה מפורטת יותר כאשר יש שגיאה

## מבנה הקבצים שתוקנו

- `apps/web/app/api/users/me/route.ts` - API למידע משתמש, תוקן ייבוא בעייתי
- `apps/web/app/api/scans/route.ts` - API מעודכן ליצירת סריקות
- `apps/web/app/api/fix-auth/route.ts` - שוכתב עם חיבור ישיר לסופאבייס
- `apps/web/app/dashboard/scans/new/page.tsx` - מניעת ריבוי מופעי סופאבייס ופישוט הממשק לAPI

## בדיקות ווידוא פעולה

יש לבצע את הבדיקות הבאות כדי לוודא שהפתרון עובד כראוי:

1. **התחברות משתמש**: התחבר למערכת ובדוק בדפדפן שהסשן נשמר
2. **צפייה בלוח הבקרה**: ודא שמוצג מידע אישי ושל הסריקות
3. **יצירת סריקה חדשה**: נסה ליצור סריקה חדשה דרך הממשק
4. **התנתקות והתחברות מחדש**: בדוק שהסשן נשמר ושהגישה לסריקות נשמרת

אם עדיין ישנן שגיאות, יש לבדוק:

- **לוגים בקונסול**: חפש הודעות שגיאה ספציפיות
- **תשובות HTTP**: בדוק את קודי התשובה וגוף התשובות מה-API
- **מצב הסשן**: בדוק את תוכן ה-Cookies והסשן בכלי הפיתוח
- **מבנה הנתונים**: ודא שטבלאות הנתונים כוללות את כל השדות הדרושים 