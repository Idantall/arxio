# מערכת תיקון אימות משתמשים

מערכת תיקון האימות פותחה כדי לפתור בעיות שנוצרו בגלל חוסר התאמה בין מערכת האימות של NextAuth לבין Supabase, במיוחד בהקשר של מזהי UUID.

## הבעיה

1. **חוסר התאמה במזהים**: מערכת NextAuth יוצרת מזהים בפורמט שונה מ-UUID של Supabase.
2. **רשומות כפולות**: משתמש אחד עשוי להיות מזוהה בשני מזהים שונים בין המערכות.
3. **מזהים לא תקינים**: מזהים שאינם בפורמט UUID תקין לא מתאימים לדרישות הסכמה של Supabase.

## הפתרון

מערכת התיקון פועלת באופן הבא:

1. **זיהוי בעיות אימות**: המערכת מזהה מצבים בהם יש חוסר התאמה בין המזהים.
2. **סנכרון אוטומטי**: ב-callback של NextAuth נוסף מנגנון שמסנכרן בין המשתמש שהתחבר למשתמש בסופאבייס.
3. **עמוד תיקון ייעודי**: המערכת מספקת דף `/auth/fix` שמאפשר למשתמשים לתקן באופן יזום את האימות שלהם.
4. **API לתיקון**: קיים נתיב API בכתובת `/api/fix-auth` שמבצע את תהליך התיקון.

## שימוש במערכת התיקון

### אוטומטי

המערכת פועלת אוטומטית בכל התחברות ובפעולות שדורשות אימות, כגון יצירת פרויקט חדש.
אם קיימת בעיית אימות, המשתמש יקבל הודעה מתאימה עם קישור לתיקון האימות.

### ידני

משתמשים יכולים לגשת לדף `/auth/fix` בכל עת כדי לתקן בעיות אימות ידנית.

## תהליך הפתרון

1. **זיהוי משתמש קיים**: המערכת מחפשת את המשתמש לפי האימייל שלו במערכת האימות של Supabase.
2. **יצירת משתמש חדש**: אם המשתמש לא קיים במערכת האימות, המערכת יוצרת משתמש חדש.
3. **סנכרון רשומת משתמש**: המערכת בודקת אם קיימת רשומה בטבלת `users` שמתאימה למשתמש.
4. **מיזוג רשומות**: אם קיימת רשומה עם אותו אימייל אבל מזהה שונה, המערכת מבצעת מיזוג של הרשומות.
5. **עדכון טבלאות קשורות**: המערכת מעדכנת את כל הטבלאות שקשורות למשתמש (פרויקטים, סריקות וכו').

## מידע טכני

- הקוד של מערכת התיקון נמצא בנתיב `/apps/web/app/api/fix-auth/route.ts`.
- פונקציות עזר נמצאות בנתיב `/apps/web/lib/user-utils.ts`.
- קיים קולבק `signIn` בהגדרות NextAuth בנתיב `/apps/web/app/api/auth/[...nextauth]/route.ts`.

## כיצד לבדוק אם משתמש תקין

ניתן לבדוק אם משתמש תקין באמצעות הקוד הבא:

```typescript
import { isValidUUID, checkUserExists } from '@/lib/user-utils';

// בדיקה שהמזהה הוא UUID תקין
const validFormat = isValidUUID(userId);

// בדיקה שהמשתמש קיים בטבלת המשתמשים
const exists = await checkUserExists(userId);
```

## מקרי קצה וטיפול בשגיאות

1. **משתמש חדש לגמרי**: אם משתמש חדש לגמרי מתחבר, המערכת יוצרת רשומות מתאימות בסופאבייס באופן אוטומטי.
2. **משתמש קיים עם מזהה שגוי**: המערכת תזהה את המצב ותיצור רשומה חדשה עם המזהה הנכון.
3. **משתמש ללא רשומה באימות**: המערכת תיצור רשומת אימות חדשה בסופאבייס.
4. **שגיאות בתהליך**: המערכת מחזירה שגיאות ברורות שמנחות את המשתמש כיצד לפתור את הבעיה.

## פתרון שגיאות נפוצות

### שגיאת "the name isValidUUID is defined multiple times"

אם נתקלתם בשגיאה זו במהלך הפיתוח, היא נובעת מכך שהפונקציה `isValidUUID` מוגדרת במספר מקומות. הפתרון הוא לוודא שהפונקציה מוגדרת רק פעם אחת (ב-`lib/user-utils.ts`) ומיובאת בשאר המקומות.

### שגיאת "Property 'email' does not exist on type 'never'"

שגיאה זו נובעת מבעיית טיפוסים בקריאה ל-`listUsers()`. הפתרון הוא להוסיף טיפוס מפורש לאובייקט המשתמש, למשל `(user: any)`.

### שגיאות בהתחברות או ביצירת פרויקטים

אם משתמשים נתקלים בשגיאות בעת התחברות או ביצירת פרויקטים שקשורות למזהה משתמש, הדרך המומלצת לפתרון היא:

1. לנווט לדף `/auth/fix` ולהפעיל את תיקון האימות
2. להתנתק ולהתחבר מחדש
3. לנסות שוב את הפעולה שרצו לבצע

## פיתוח עתידי

המערכת נועדה לפתור בעיות שנוצרו במעבר בין גרסאות שונות של המערכת ושימוש בספקי אימות שונים. בטווח הארוך, רצוי לבצע מספר שיפורים:

1. **שימוש עקבי במזהים**: הגדרת תבנית אחידה למזהי משתמש בין כל המערכות
2. **בדיקות אוטומטיות**: הוספת בדיקות שמזהות בעיות אימות באופן אוטומטי
3. **ניטור**: הוספת ניטור לתהליכי אימות כדי לזהות בעיות במהירות

## פרטים נוספים

לשאלות נוספות או דיווח על בעיות, צרו קשר עם צוות הפיתוח. 